name: Release

on:
  push:
    branches: [main]
    paths-ignore:
      - 'README.md'
      - 'CHANGELOG.md'

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Build and release for macOs and Linux
  release-mac-linux:
    name: Release (${{ matrix.os }})
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          # - os: windows-latest
          #   platform: windows
          - os: macos-latest
            platform: mac

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      # Need python for gyp on macOS
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: npm ci

      # Install fpm on Linux for packaging .deb and .rpm
      #- name: Install fpm (Linux)
      #  if: runner.os == 'Linux'
      #  run: |
      #    sudo apt-get update
      #    sudo apt-get install -y ruby ruby-dev rubygems build-essential
      #    sudo gem install --no-document fpm

      - name: LINUX - Build and release
        if: matrix.platform == 'linux'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EP_DRAFT: true
          EP_PRE_RELEASE: false
        run: npm run build:linux -- --linux AppImage --publish always

      - name: MACOS - Build, sign and release
        if: matrix.platform == 'mac'
        # Use the `nick-fields/retry` to retry the command in case the code signing fails
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 180 # 3 Hours max per try
          max_attempts: 3
          command: npm run build:mac -- --publish always
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EP_DRAFT: true
          EP_PRE_RELEASE: false

          # electron-builder signing inputs
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: matrix.platform == 'linux' || matrix.platform == 'mac'
        with:
          name: release-${{ matrix.platform }}
          path: |
            dist/*.dmg
            dist/*.zip
            dist/*.AppImage
          if-no-files-found: error

      # - name: Upload unsigned Windows artifacts
      #   if: matrix.platform == 'windows'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: unsigned-windows
      #     path: dist/*.exe
      #     if-no-files-found: error
      #     retention-days: 1

  # Build and release for Windows (Self-hosted runner)
  release-windows:
    name: Release (windows-latest)
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: WINDOWS - Build, sign and release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EP_DRAFT: true
          EP_PRE_RELEASE: false
          PKCS11_MODULE_PATH: ${{ secrets.PKCS11_MODULE_PATH }}
          CERT_PATH: ${{ secrets.CERT_PATH }}
          CERT_KEY: ${{ secrets.CERT_KEY }}
          CERT_TOKEN_PIN: ${{ secrets.CERT_TOKEN_PIN }}
          CERT_TIME_SERVER: ${{ secrets.CERT_TIME_SERVER }}
        run: npm run build:win -- --publish always

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: |
            dist/*.exe
          if-no-files-found: error

      # - name: Download unsigned Windows artifacts
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: unsigned-windows
      #     path: unsigned

      # - name: Sign Windows artifacts with token
      #   env:
      #     PKCS11_MODULE_PATH: ${{ secrets.PKCS11_MODULE_PATH }}
      #     CERT_PATH: ${{ secrets.CERT_PATH }}
      #     CERT_KEY: ${{ secrets.CERT_KEY }}
      #     CERT_TOKEN_PIN: ${{ secrets.CERT_TOKEN_PIN }}
      #     CERT_TIME_SERVER: ${{ secrets.CERT_TIME_SERVER }}
      #   run: |
      #     mkdir -p signed
      #     for f in unsigned/*.exe; do
      #       base=$(basename "$f")
      #       sudo osslsigncode sign \
      #         -pkcs11module "$PKCS11_MODULE_PATH" \
      #         -certs "$CERT_PATH" \
      #         -key "$CERT_KEY" \
      #         -pass "$CERT_TOKEN_PIN" \
      #         -h sha256 \
      #         -n "SkinsTrackr" \
      #         -i "https://github.com/SkinsTrackr/skinstrackr" \
      #         -t "$CERT_TIME_SERVER" \
      #         -in "$f" \
      #         -out "signed/$base"
      #     done

      # - name: Upload signed Windows artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: release-windows
      #     path: signed/*.exe

      # - name: Setup Node
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: 22
      #     cache: npm

      # - name: Regenerate blockmap and release.yml for signed .exe (Needed for auto-updates)
      #   run: |
      #     npm install -g electron-builder
      #     for f in signed/*.exe; do
      #       npx electron-builder blockmap --input="$f"
      #     done

      # - name: Upload signed Windows blockmap and yml (Needed for auto-updates)
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: release-windows-meta
      #     path: |
      #       signed/*.exe.blockmap
      #       signed/release.yml

  finalize-release:
    name: Add Release Notes
    needs: [release-mac-linux, release-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from package.json
        id: version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Extract changelog for current version
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            # Extract changelog section for current version
            VERSION="${{ steps.version.outputs.version }}"
            awk -v ver="$VERSION" '
              /^## \[?'$VERSION'\]?/ { found=1; next }
              /^## / { if (found) exit }
              found { print }
            ' CHANGELOG.md > current_changelog.txt
            
            if [ -s current_changelog.txt ]; then
              echo "HAS_CHANGELOG=true" >> $GITHUB_OUTPUT
            else
              echo "HAS_CHANGELOG=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "HAS_CHANGELOG=false" >> $GITHUB_OUTPUT
          fi

      # - name: Download signed Windows artifacts for release
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: release-windows
      #     path: dist

      # - name: Download signed Windows blockmap and yml for release
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: release-windows-meta
      #     path: dist

      - name: Update release with notes
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          draft: true
          generate_release_notes: ${{ steps.changelog.outputs.HAS_CHANGELOG == 'false' }}
          body_path: ${{ steps.changelog.outputs.HAS_CHANGELOG == 'true' && 'current_changelog.txt' || '' }}
          # files: |
          #   dist/*.exe
          #   dist/*.exe.blockmap
          #   dist/release.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
